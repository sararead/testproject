references:
  builderbox: &builderbox
    docker:
      - image: circleci/php:7.2.10-cli-stretch-node-browsers-legacy
#    parallelism: 4
    
  do_checkout: &do_checkout
      - checkout
      - run: git status
  run_on_master_tagged: &run_on_master_tagged
    filters:
      branches:
        only: /master/
      tags:
        ignore: /^v.*/

jobs:
  build:
    <<: *builderbox
    steps:
      - run: npm install
  test:
    <<: *builderbox
    steps:
      - checkout
      - run: git status
      - run: echo $Saras_Test
      - run: cd ios && bundle exec fastlane $FASTLANE_LANE
  secondImage:
    docker:
      - image: circleci/ruby:2.3-jessie-node-browsers
      - image: sread/get-started:part2
        auth:
          username: sread
          password: $DOCKERHUB_PASSWORD
    steps:
      - checkout
      - run: git status
  privateImage:
    docker:
      - image: sread/get-started:part2
        auth:
          username: sread
          password: $DOCKERHUB_PASSWORD
    steps:
      - checkout
      - run: git status
      
   ipv6_tests:
     machine: true
     steps:
     - checkout
     - run:
         name: enable ipv6
         command: |
           cat <<'EOF' | sudo tee /etc/docker/daemon.json
           {
             "ipv6": true,
             "fixed-cidr-v6": "2001:db8:1::/64"
           }
           EOF
           sudo service docker restart
workflows:
  version: 2
  test-build-deploy:
    jobs:
      - ipv6_tests
      - build:
          <<: *run_on_master_tagged        
      - test:
          context: Testing
      - secondImage
      - privateImage
